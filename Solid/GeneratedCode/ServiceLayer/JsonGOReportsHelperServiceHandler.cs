////////////////////////////////////////////////////////////////////////////////////////////
// This is Generated Code
// You should not modify this code as it may be overwritten. Use Partial classes instead
// Generated By Generative Objects  
//////////////////////////////////////////////////////////////////////////////////////////// 
using System;
using System.IO;
using System.IO.Compression;
using System.Text;
using System.Web;
using Newtonsoft.Json;
using Solid.ServiceLayer.Json;
using Solid.Data.DataObjects;
using Solid.Data.DataObjects.Factories;
using Solid.BusinessLayer.Components.Server;
using System.Security.Claims;
using GenerativeObjects.Practices.ORMSupportClasses;
using GenerativeObjects.Practices.DependencyInjection;
using GenerativeObjects.Practices.Logging;
using GenerativeObjects.Practices.Settings;
using GenerativeObjects.Practices.ExceptionHandling;
using System.Collections.Generic;
using System.Web.SessionState;
using System.Net;
using GenerativeObjects.Practices.LayerSupportClasses;
using GenerativeObjects.Practices.LayerSupportClasses.ServiceLayer;
using GenerativeObjects.Practices.LayerSupportClasses.ServiceLayer.Extensions;
using GenerativeObjects.Practices.LayerSupportClasses.ServiceLayer.Http;
using GenerativeObjects.Practices.LayerSupportClasses.DataLayer;
using Unity;

namespace Solid.ServiceLayer.WebHandlers
{
    public class JsonGOReportsHelperServiceHandler : ApiHandler
    {
		private ILogEngine _logEngine;

		public JsonSerializerSettings GetSerializationSettings(bool isDatasetAPI)
		{
			JsonSerializerSettings settings;	
			
			if (isDatasetAPI)
				settings  = new JsonSerializerSettings() { Binder = new TypeNameSerializationBinder("Solid.Data.DataObjects.{0}, Solid.Data.DataObjects")};
			else
			{
                bool byRef = true;

                if (HttpContext.Current.Request["byRef"] != null)
                {
                    if (!bool.TryParse(HttpContext.Current.Request["byRef"], out byRef))
                        byRef = true;

                }

				if (byRef)
				{
					settings = new JsonSerializerSettings() { Binder = new TypeNameSerializationBinder("Solid.Data.DataObjects.{0}, Solid.Data.DataObjects"), PreserveReferencesHandling = PreserveReferencesHandling.Objects  };
				}
				else
				{				
					settings = new JsonSerializerSettings() { Binder = new TypeNameSerializationBinder("Solid.Data.DataObjects.{0}, Solid.Data.DataObjects"), PreserveReferencesHandling = PreserveReferencesHandling.None, ReferenceLoopHandling = ReferenceLoopHandling.Ignore };
				}				
			}

			if (isDatasetAPI)
			{
				settings.TypeNameHandling = TypeNameHandling.Auto;
			}
			else
			{
				settings.TypeNameHandling = TypeNameHandling.Objects;
			}

			var context = HttpContext.Current;
			if (context.Request["dateformat"] != null && context.Request["dateformat"] == "microsoft")
				settings.DateFormatHandling = DateFormatHandling.MicrosoftDateFormat;
			else
				settings.DateFormatHandling = DateFormatHandling.IsoDateFormat;

			return settings;
		}

		private IComponentApiExtensionProvider Extensions
		{
			get
			{
				// Resolve Extensions Provider
				var extensions = ApplicationSettings.Container.Resolve<IComponentApiExtensionProvider>();

				// Ensure initialised
				if (extensions != null)
				{
					// Initialise and hook up extensions
					extensions.Init();
				}
				else
				{
					throw new Exception("Component Extensions Initialization error: required dependency was unresolved");
				}
				
				return extensions;
			}
		}

        public override void DoProcessRequest(HttpContext context)
        {
			Exception error = null;

			try
			{
				// Set response headers
				context.Response.ContentType = "application/json";
				context.Response.ContentEncoding = Encoding.UTF8;

				// Notify 'request begins' to extensions
				Extensions.OnRequestAction(new ApiExtensionResponseData { action = context.Request.HttpMethod, context = "BEGIN", data = null });

				// Extract request parts via an ApiRequest wrapper
				ApiRequest request = new ApiRequest(context);
				bool isDatasetAPI = request.IsDatasetApi;
				string methodName = request.MethodName;

				// Enable GZip Compression if client support it
				AddGZipCompression(context, request.AcceptGZip);

				switch (context.Request.HttpMethod)
				{
					case "GET":
					case "POST":
                    {
						switch (methodName)
						{
							case "getembeddedreporturl":
							{	
									// Notify Extensions
									{
										var args = new Dictionary<string, string>()
										{
											{ "reportId", context.Request["reportId"] },
											{ "payload", context.Request["payload"] },
										};

										// Notify method call to extensions
										Extensions.OnRequestAction(new ApiExtensionResponseData { action = "GetEmbeddedReportUrl", context = "BEFORE_CALL", data = JsonConvert.SerializeObject(args) });
									}

									var result = JsonGOReportsHelperService.GetEmbeddedReportUrl(String.IsNullOrEmpty(context.Request["reportId"]) ? Guid.Empty : Guid.Parse(context.Request["reportId"]), String.IsNullOrEmpty(context.Request["payload"]) ? null : Convert.ToString(context.Request["payload"]));
									
									// Seralise result, if not already json encoded string
									string json = result;
									
									if (!IsJson(result))
										json = JsonConvert.SerializeObject(result, GetSerializationSettings(false));

									// Notify result to extensions
									Extensions.OnRequestAction(new ApiExtensionResponseData { action = "GetEmbeddedReportUrl", context = "JSON", data = json });
									
									WriteResponse(context, json);
							}
								break;
							default:
								_logEngine.LogError("Unknown json method: " + methodName, "Unknown json method: "+ methodName, "JsonGOReportsHelperServiceHandler", null);
								throw new PulpException("Unknow json method: " + methodName);
						}
                    }
                    break;
                case "OPTIONS":
                    return;
                default:
                    throw new InvalidOperationException("Invalid Verb " + context.Request.HttpMethod);
				}
			}
			catch (Exception exception)
			{
				error = exception;

				// Notify to extensions and re-throw
				Extensions.OnRequestAction(new ApiExtensionResponseData { action = "EXCEPTION", context = exception.GetType().Name, data = exception.ToString(), error = true });
				throw;
			}
			finally
			{
				// Check no transaction left running
				DatabaseTransaction.AbortAnyOngoingTransaction(error);
			}
        }

		public static void WriteResponse(HttpContext context, string jsonData)
		{
			// case jsonp
			if (context.Request["callback"] != null)
                context.Response.Write(String.Format("{0}({1});", context.Request["callback"], jsonData));
            else
                context.Response.Write(jsonData);
		}

		/// <summary>
	    /// If the request indicate that it allow to server to send GZip data, add the proper header.
		/// </summary>
		public static void AddGZipCompression(HttpContext context, bool acceptGZip)
		{
			if (acceptGZip)
			{
				context.Response.Filter = new GZipStream(context.Response.Filter, CompressionMode.Compress);
				HttpContext.Current.Response.AppendHeader("Content-encoding", "gzip");
			} 
		}

	
        public override bool IsReusable
        {
            // To enable pooling, return true here.
            // This keeps the handler in memory.
            get { return true; }
        }

		private bool IsJson(string s)
		{
			if (string.IsNullOrEmpty(s))
				return false;

			s = s.Trim();
			return (s.StartsWith("{") && s.EndsWith("}")) || (s.StartsWith("[") && s.EndsWith("]"));
		}
    }
}
