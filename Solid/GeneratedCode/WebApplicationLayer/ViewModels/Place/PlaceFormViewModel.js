////////////////////////////////////////////////////////////////////////////////////////////
// This is Generated Code
// You should not modify this code as it may be overwritten. Use Partial classes instead
// Generated By Generative Objects  
//////////////////////////////////////////////////////////////////////////////////////////// 

(function () {
	// 
	Solid.Web.ViewModels.PlaceFormViewModel = function(controller, $formContainer, sDataBindRoot, $popupContainer, parentContextId, options) {
		var self = this;
		this.controller = controller;
		this.subscriptions = [];

		if (sDataBindRoot)
			sDataBindRoot = sDataBindRoot + ".";
		else
			sDataBindRoot = "";
			
		this.$formContainer = $formContainer;

		this.contextId = parentContextId ? parentContextId.concat([this.controller.applicationController.getNextContextId()]) : [this.controller.applicationController.getNextContextId()];
		this.popupWidth = options && options.popupWidth;
		this.alternateTitle = options && options.alternateTitle;

		this.DataStore = new Solid.Web.Model.DataStores.DataStore(controller.applicationController.ObjectsDataSet, 'place');
		// Related Data Stores
		this.DataStoreCountry = new Solid.Web.Model.DataStores.DataStore(new Solid.Web.Model.DataSets.ObjectsDataSet(), 'country');

 
		this.isMemoryOnly = false;

		// Object data
		this.PlaceObject = ko.observable(new Solid.Web.Model.DataObjects.PlaceObject());
		this.PlaceObject().ObjectsDataSet = this.controller.ObjectsDataSet;
		this.CurrentObject = ko.pureComputed(function () { return this.PlaceObject() }, this);

		// Sub-grids ViewModels
		this.PlaceToLocationItemsGridViewModel = new Solid.Web.ViewModels.PlaceToLocationGridViewModel(self.controller, null, sDataBindRoot +  "PlaceToLocationItemsGridViewModel", $popupContainer, self.contextId);
		this.PlaceToLocationItemsGridViewModel.getSourceCollection = function () { return self.PlaceObject().getPlaceToLocationItems(); };		
		this.PlaceToLocationItemsGridViewModel.CreateNewCommandInitActions.push ( 
			function (newobject) {
				newobject.setPlace(self.CurrentObject());; 
		});				
		
		this.CallAfterSaveRelatedEntity = null;
			// Lookup fields display fields
		this.Country_Name = ko.observable(null);
		this.Country_lookupItem = ko.observable(null); //Storing current selected item for this lookupfield
 
		// Form status data
        this.StatusData = {
			IsUIDirty : ko.observable (false),
			CurrentTabIndex: ko.observable(1),
			// Visibility rules for Tabs.
			IsPlaceToLocationTabVisible : ko.observable(true),
			IsMainTabVisible : ko.observable(true),
            // Control properties         
			IsBusy: ko.observable(false),
            IsEnabled: ko.observable(true),
			IsVisible: ko.observable(true),
            DisplayMode: ko.observable('view'),
            ShowTitle : ko.observable(true),

            PreviousIsEmpty : true,
            IsEmpty : ko.observable(true),
			isPopup : ko.observable(false),
			isValid : ko.observable(true),
			errorSummary : ko.observableArray()
		};

 
		// Integrate custom code if any
		if (Solid.Web.ViewModels.PlaceFormViewModelCustom !== undefined) {
		    this.customViewModel = new Solid.Web.ViewModels.PlaceFormViewModelCustom(self);
		};

		this.StatusData.Title = ko.pureComputed(function() { 
			if (self.customViewModel !== undefined && self.customViewModel.Title !== undefined) {
				return self.customViewModel.Title();
			}	
			
			if(!self.PlaceObject())
				return;
							
			return self.alternateTitle || 'Place Details'; 
		});

		this.StatusData.PlaceToLocationTabTitle = ko.pureComputed(function() { 
			if (self.customViewModel !== undefined && self.customViewModel.PlaceToLocationTabTitle !== undefined) {
				return self.customViewModel.PlaceToLocationTabTitle();
			}	
			
			if(!self.PlaceObject())
				return;
							
			return 'Place To Location Items Items'; 
		});

		this.StatusData.MainTabTitle = ko.pureComputed(function() { 
			if (self.customViewModel !== undefined && self.customViewModel.MainTabTitle !== undefined) {
				return self.customViewModel.MainTabTitle();
			}	
			
			if(!self.PlaceObject())
				return;
							
			return 'Main'; 
		});

		this.runValidation = function() {
			self.PlaceObject().runValidation();

			var isValid = self.PlaceObject().StatusData.isValid();
			self.StatusData.errorSummary.removeAll();
			for (var i=0; i < self.PlaceObject().StatusData.errorSummary().length; i++) {
				self.StatusData.errorSummary.push(self.PlaceObject().StatusData.errorSummary()[i]);
			}

			// Remove duplicates
			self.StatusData.errorSummary(GO.Array.Distinct(self.StatusData.errorSummary()));

			self.StatusData.isValid(isValid);
		};

		this.resetValidation = function () {
			self.PlaceObject().resetValidation();
			self.StatusData.isValid(true);
			self.StatusData.errorSummary.removeAll();
		};

		this.onContextIdsStatusChanged = function() {
			self.StatusData.IsUIDirty(self.controller.ObjectsDataSet.isContextIdDirty(self.contextId));			
		};

		this.controller.ObjectsDataSet.AddContextIdsStatusChangeHandler(self.onContextIdsStatusChanged);

		this.subscriptions.push(this.StatusData.DisplayMode.subscribe ( function (newValue) {
			if (newValue === "edit")	{
				self.loadRelatedData();
			}
		}));

		this.StatusData.IsPlaceToLocationItemsVisible = ko.pureComputed( function () {
			if (self.customViewModel !== undefined && self.customViewModel.IsPlaceToLocationItemsVisible !== undefined) {
				return self.customViewModel.IsPlaceToLocationItemsVisible();
			}
			
			return true;
		});

		this.StatusData.IsPlaceToLocationItemsReadOnly = ko.pureComputed( function () {
			if (self.customViewModel !== undefined && self.customViewModel.IsPlaceToLocationItemsReadOnly !== undefined) {
				return self.customViewModel.IsPlaceToLocationItemsReadOnly();
			}
			return false;
        });

		this.StatusData.IsCountryVisible = ko.pureComputed( function () {
			if (self.customViewModel !== undefined && self.customViewModel.IsCountryVisible !== undefined) {
				return self.customViewModel.IsCountryVisible();
			}
			
			return true;
		});

		this.StatusData.IsCountryReadOnly = ko.pureComputed( function () {
			if (self.customViewModel !== undefined && self.customViewModel.IsCountryReadOnly !== undefined) {
				return self.customViewModel.IsCountryReadOnly();
			}
			return false;
        });

		this.StatusData.IsURIVisible = ko.pureComputed( function () {
			if (self.customViewModel !== undefined && self.customViewModel.IsURIVisible !== undefined) {
				return self.customViewModel.IsURIVisible();
			}
			
			return true;
		});

		this.StatusData.IsURIReadOnly = ko.pureComputed( function () {
			if (self.customViewModel !== undefined && self.customViewModel.IsURIReadOnly !== undefined) {
				return self.customViewModel.IsURIReadOnly();
			}
			return false;
        });

		this.StatusData.IsNameVisible = ko.pureComputed( function () {
			if (self.customViewModel !== undefined && self.customViewModel.IsNameVisible !== undefined) {
				return self.customViewModel.IsNameVisible();
			}
			
			return true;
		});

		this.StatusData.IsNameReadOnly = ko.pureComputed( function () {
			if (self.customViewModel !== undefined && self.customViewModel.IsNameReadOnly !== undefined) {
				return self.customViewModel.IsNameReadOnly();
			}
			return false;
        });

		this.StatusData.IsAbstractVisible = ko.pureComputed( function () {
			if (self.customViewModel !== undefined && self.customViewModel.IsAbstractVisible !== undefined) {
				return self.customViewModel.IsAbstractVisible();
			}
			
			return true;
		});

		this.StatusData.IsAbstractReadOnly = ko.pureComputed( function () {
			if (self.customViewModel !== undefined && self.customViewModel.IsAbstractReadOnly !== undefined) {
				return self.customViewModel.IsAbstractReadOnly();
			}
			return false;
        });

		// Propagate Display Mode change to subgrids
        this.subscriptions.push(this.StatusData.DisplayMode.subscribe (function(newValue) {
			self.PlaceToLocationItemsGridViewModel.StatusData.DisplayMode(newValue);	
		}));
		// Form events data
		this.Events = {
            PlaceLoaded: ko.observable(false),
            PlaceSaved: ko.observable(false),
            PlaceDeleted: ko.observable(false),
			PlaceSetInMemory: ko.observable(false),
            StartEdit: ko.observable(false),
            CancelEdit: ko.observable(false),
            EndEdit: ko.observable(false)
		};
				
		// Form commands data
		this.Commands = {
			CreateNewCommand: function() {
				self.CreateNew(true);
			}, 
			EditCommand: function() {
				self.Edit(true);
			}, 
			DeleteCommand: function() {
				self.Delete(true);
			}, 
			SaveCommand: function() {
				self.Save(true);
			}, 
			CancelEditCommand: function() {
				self.CancelEdit(true);
			} 
      };

		// Form computed command data
      this.Commands.IsSaveCommandVisible = ko.pureComputed(function () {
			if (self.customViewModel !== undefined && self.customViewModel.IsSaveCommandVisible !== undefined) {
				return self.customViewModel.IsSaveCommandVisible();
			}

            return (self.StatusData.DisplayMode() == 'edit' && self.DataStore &&  self.DataStore.CheckAuthorizationForEntityAndMethod('save')); 
        });

        this.Commands.IsSaveCommandEnabled = ko.pureComputed(function () {
			if (self.customViewModel !== undefined && self.customViewModel.IsSaveCommandEnabled !== undefined) {
				return self.customViewModel.IsSaveCommandEnabled();
			}

            return (self.StatusData.DisplayMode() == 'edit');
            //return (self.StatusData.DisplayMode() == 'edit' && self.StatusData.IsUIDirty() === true);
        });

      this.Commands.IsEditCommandVisible = ko.pureComputed(function () {
			if (self.customViewModel !== undefined && self.customViewModel.IsModifyCommandVisible !== undefined) {
				return self.customViewModel.IsModifyCommandVisible();
			}

            return (self.StatusData.DisplayMode() == 'view' && !self.StatusData.IsEmpty() && self.DataStore && self.DataStore.CheckAuthorizationForEntityAndMethod('save')); 
        });
        this.Commands.IsModifyCommandVisible = this.Commands.IsEditCommandVisible;

        this.Commands.IsEditCommandEnabled = ko.pureComputed(function () {
			if (self.customViewModel !== undefined && self.customViewModel.IsModifyCommandEnabled !== undefined) {
				return self.customViewModel.IsModifyCommandEnabled();
			}

            return (self.StatusData.DisplayMode() == 'view');
        });
        this.Commands.IsModifyCommandEnabled = this.Commands.IsEditCommandEnabled;

      this.Commands.IsDeleteCommandVisible = ko.pureComputed(function () {
			if (self.customViewModel !== undefined && self.customViewModel.IsDeleteCommandVisible !== undefined) {
				return self.customViewModel.IsDeleteCommandVisible();
			}
			
			return (self.StatusData.DisplayMode() == 'view' && !self.StatusData.IsEmpty()  && self.DataStore &&  self.DataStore.CheckAuthorizationForEntityAndMethod('delete')); 

        });

        this.Commands.IsDeleteCommandEnabled = ko.pureComputed(function () {
			if(self.customViewModel !== undefined && self.customViewModel.IsDeleteCommandEnabled !== undefined) {
				return self.customViewModel.IsDeleteCommandEnabled();
			}
            return (self.StatusData.DisplayMode() == 'view');
        });

      this.Commands.IsCreateNewCommandVisible = ko.pureComputed(function () {
			if (self.customViewModel !== undefined && self.customViewModel.IsCreateNewCommandVisible !== undefined) {
				return self.customViewModel.IsCreateNewCommandVisible();
			}

            return (self.StatusData.DisplayMode() == 'view' && !self.StatusData.isPopup() && self.DataStore && self.DataStore.CheckAuthorizationForEntityAndMethod('save')); 
        });

        this.Commands.IsCreateNewCommandEnabled = ko.pureComputed(function () {
			if (self.customViewModel !== undefined && self.customViewModel.IsCreateNewCommandEnabled !== undefined) {
				return self.customViewModel.IsCreateNewCommandEnabled();
			}

            return (self.StatusData.DisplayMode() == 'view' && !self.StatusData.isPopup());
        });

		this.Commands.IsCancelEditCommandVisible = ko.pureComputed(function () {
			if (self.customViewModel !== undefined && self.customViewModel.IsCancelEditCommandVisible !== undefined) {
				return self.customViewModel.IsCancelEditCommandVisible();
			}

            return  (self.StatusData.DisplayMode() == 'edit'); 
        });

        this.Commands.IsCancelEditCommandEnabled = ko.pureComputed(function () {
			if (self.customViewModel !== undefined && self.customViewModel.IsCancelEditCommandEnabled !== undefined) {
				return self.customViewModel.IsCancelEditCommandEnabled();
			}

            return (self.StatusData.DisplayMode() == 'edit');
        });


		// var generatedIncludes = "Country";
		// The server auto-maps the include path if we send the following auto-include-id
		this.include = "auto-include-id-b48eb8ed-7966-448f-8b22-5af2622ffef5";
		// Popups management
        // this.viewLoader = new Solid.Web.Views.viewLoader();
		this.viewLoader = controller.applicationController.viewLoader;

        this.popupCaller = null;
		this.$popupContainer = $popupContainer;
		
        //The close event is emitted by the dialog extension - see html markup
        this.onPopupClosed = function (rebindrequired) {
			self.StatusData.isPopup(false);
		    if (self.StatusData.DisplayMode() === 'edit') {
		        self.CancelEdit(false);
		    }
			if (rebindrequired) {
				self.popupCaller.Rebind();
			}
			self.release();
        };

		this.showAsEditPopup = function(caller, objectToEdit) {
        // Dynamically load the required view
			self.StatusData.IsBusy(true);
            self.viewLoader.loadView( { viewName : "PartialViews/Place/PlaceFormControlPartialView", parentName : ($popupContainer ? $popupContainer.get(0).id : null), successHandler : self.onViewLoaded } ); 
            self.popupCaller = caller;
            if (self.isMemoryOnly) {
                    self.SetPlaceObject(objectToEdit);
            }
            else {
                    self.LoadPlace(objectToEdit);
            }
            self.StatusData.isPopup(true);
        };

		this.showAsCreateNewPopup = function(caller, defaultObject) {
             // Dynamically load the required view
            self.StatusData.IsBusy(true);
            self.viewLoader.loadView( { viewName : "PartialViews/Place/PlaceFormControlPartialView", parentName : ($popupContainer ? $popupContainer.get(0).id : null), successHandler : self.onViewLoaded } ); 
            self.popupCaller = caller;

            self.SetPlaceObject(defaultObject);
			self.controller.ObjectsDataSet.AddOrReplaceObject(self.PlaceObject());

            self.StatusData.isPopup(true);
            self.Modify();
        };          

		this.closePopup = function (rebindrequired) {
			controller.applicationController.closeCurrentPopup(rebindrequired);
        };

        this.onViewLoaded = function (viewData) {
            self.$popupContainer.html(viewData);
			self.$popupContainer.show();

			ko.applyBindings(self, self.$popupContainer.get(0));
        	self.StatusData.IsBusy(false);

			self.controller.applicationController.centerPopup();
        };

		// Related data popups
		this.isShowEditCountryPopupVisible = function () {
			return true;
		};

		this.isShowEditCountryPopupEnabled = function () {
			return self.PlaceObject().getCountry() != null;
		};

		this.showEditCountryPopup = function () {
			var objectToShow = self.PlaceObject().getCountry();
			// Preventing errors due to visualization of informations of an empty element.
			if (!objectToShow)
				return;
			if (objectToShow != null) {
				objectToShow.ObjectsDataSet = self.controller.ObjectsDataSet;
			}

			var isMemoryOnly = objectToShow != null && objectToShow.Data.IsNew();

			// Callback called when popup is closed
			self.CallAfterSaveRelatedEntity = self.selectCountryLookupField; 

			self.controller.applicationController.showEditPopup("CountryForm", self, objectToShow, isMemoryOnly, null, "70%");
			GO.log("PlaceForm", "Opening lookup popup on CountryForm");
		};

		this.Commands.isShowCreateNewCountryPopupVisible = function () {
			if (self.customViewModel !== undefined && self.customViewModel.isShowCreateNewCountryPopupVisible !== undefined) {
				return self.customViewModel.isShowCreateNewCountryPopupVisible();
			}

			return true;
		};

		this.Commands.isShowCreateNewCountryPopupEnabled = function () {
			if (self.customViewModel !== undefined && self.customViewModel.isShowCreateNewCountryPopupEnabled !== undefined) {
				return self.customViewModel.isShowCreateNewCountryPopupEnabled();
			}
			return true;
		};

		this.Commands.showCreateNewCountryPopup = function () {

 
            var newObject = Solid.Web.Model.DataObjects.CountryObjectFactory.createNew(self.controller.ObjectsDataSet, self.contextId);

			newObject.DirtyHandlerOn = false;
            newObject.DirtyHandlerOn = true;
				
			// Callback called when popup is closed
			self.CallAfterSaveRelatedEntity = self.selectCountryLookupField; 

			var isPKSideToFKSidePopup = false;
			var isMemoryOnly = isPKSideToFKSidePopup ? true : self.isMemoryOnlyCollection;
            self.controller.applicationController.showCreateNewPopup("CountryForm", self, newObject, isMemoryOnly, self.contextId, "70%");
        };
		// Related data collections
		this.Country_lookupMethod = null; //set on loadData
		this.Country_lookupThreshold = 100; // Threshold for automatic switch
		this.Country_lookupMinLength = ko.observable(0);
		this.countryCollection = ko.observableArray();
		this.CountryContextId = this.contextId.concat([this.controller.applicationController.getNextContextId()]);

		this.clearCountryCollection = function() {
			for (var i = 0; i < self.countryCollection.length; i++) {
				if (self.countryCollection[i].Data.IsNew() == true) {
					self.controller.ObjectsDataSet.RemoveObject(self.countryCollection[i]);
				}				
			}
            
            self.countryCollection.removeAll();		
		};

		// Give custom code opportunity to post-process / filter country collection before adding to lookup
		this.includeCountryInLookup = function (country) {
		    if (self.customViewModel !== undefined && self.customViewModel.includeCountryInLookup !== undefined) {
		        return self.customViewModel.includeCountryInLookup(country);
		    }

		    return true;
		}

		this.setCountryCollection = function (data) {
			self.clearCountryCollection();
			            
			var currentSelectedIsInList = false;

			if (data) {
				for (var i=0; i < data.length; i++) {
					if (self.includeCountryInLookup(data[i])) {                		
						self.countryCollection.push(data[i]);
					
						if (self.Country_lookupItem() !== null && self.Country_lookupItem().value !== null && self.Country_lookupItem().value.Data.URI() == data[i].Data.URI()) {
                			currentSelectedIsInList = true;
                		}
					}
				}

				// If the current item is not in 
				if(self.Country_lookupItem() !== null && self.Country_lookupItem().value !== null && !currentSelectedIsInList) {
					self.countryCollection.push(self.Country_lookupItem().value);
					currentSelectedIsInList = true;
				}
				
				// For autocomplete mode, we need to check that the current item is not null before emptying
				if (self.Country_lookupItem() !== null && self.Country_lookupItem().value !== null && currentSelectedIsInList == false) {
					self.Country_lookupItem({ label: "", value: null, selectable: true });
				}
            }
		};

		this.getLookupAddItemLabelTextForCountry = function (){
			return Solid.Web.Messages.addItemLabel;
		}

		this.constructCountryArrayFlatForLookup = function () {
             var result = [], l = self.countryCollection().length;
			 var emptyItem = { label: Solid.Web.Messages.noAvailableDataLabel + '. ' + self.getLookupAddItemLabelTextForCountry(), value: '', selectable: true, command: 'create'}

			 if (l === 0 && !!self.getLookupAddItemLabelTextForCountry()) {
		        result.push(emptyItem);
		        return result;
		    }

            for (var i=0; i < l; i++) {				
				result.push( { label : self.countryCollection()[i].Data.Name(), value : self.countryCollection()[i], selectable: true } );				
            }
			if (!!self.getLookupAddItemLabelTextForCountry()) {
				emptyItem.label = self.getLookupAddItemLabelTextForCountry();
				result.push(emptyItem);
			}
			return result;
		};
		this.getCountryCollectionData = function (callback) {
			self.isGetCountryCollectionBusy(true);	
					
			var configuration = {};
			configuration.contextId = self.CountryContextId;
			configuration.successHandler = callback || self.onGetCountryCollectionDataSuccess;

			configuration.errorHandler = self.onGetCountryCollectionDataError;

			self.DataStoreCountry.LoadObjectCollection(configuration);
			
		};

		this.getCountryCollectionOneLevel = function (request, response) {
                response($.ui.autocomplete.filter(self.constructCountryArrayFlatForLookup(), request.term));
        };	
		this.getFilteredCountryCollectionData = function (searchValue, callback) {
					
			var configuration = {};
			configuration.contextId = self.CountryContextId;
			configuration.filterPredicate = 'Name.StartsWith("' + searchValue + '")';
			configuration.pageSize = 50;
			configuration.pageNumber = 1;
			configuration.successHandler = callback;

			configuration.errorHandler = self.onGetCountryCollectionDataError;

			self.DataStoreCountry.LoadObjectCollection(configuration);
			
		};

		this.getCountryAutoComplete = function (request, response) {
            self.getFilteredCountryCollectionData(request.term, function (data) {
                self.setCountryCollection(data);
                response(self.constructCountryArrayFlatForLookup());
            });
        };


		// This method is called when the user selects an item in the lookup field
		// It is used to add custom behavior and then calls the next method onSelectedCountryChanged 
		// which deals with the change internally
		this.onLookupCountryChanged = function (item) {
		    var doContinue = true;
		    if (self.customViewModel !== undefined && self.customViewModel.onLookupCountryChanged !== undefined) {
		        doContinue = self.customViewModel.onLookupCountryChanged(item);
		    }
		    if (doContinue) {
				if (item.command === 'create') {
		            item.label = '';
		            self.Commands.showCreateNewCountryPopup();
		            return;
		        } 
 
				if (item.value !== null) {		
					self.controller.ObjectsDataSet.AddOrReplaceObject(item.value.Clone());
				}

		        self.onSelectedCountryChanged(item.value);
		    }
		};

		// Update when lookup selection changed
		this.onSelectedCountryChanged = function (selectedObject)  {
 
			if (selectedObject == null) {
				self.PlaceObject().Data.CountryURI(null);
				self.PlaceObject().Data._country_NewObjectId(null); 
			}
			else if (selectedObject.Data.IsNew() === false) {
				self.PlaceObject().Data.CountryURI(selectedObject.Data.URI());
			}
			else {
				self.PlaceObject().Data._country_NewObjectId(selectedObject.Data.InternalObjectId());
			}

		};

		//Specific functions for Automatic load
		this.countCountryElements = function (callback) {
			var configuration = {};
			configuration.contextId = self.CountryContextId;
			
			configuration.successHandler = callback;
			configuration.errorHandler = function() { callback(0); };

			self.DataStoreCountry.CountObjects(configuration);
		};

		this.getCountryForLookupAutomatic = function(request, response)  {
			self.Country_lookupMethod && self.Country_lookupMethod(request, response);
		};

		this.selectiveLoadDataForCountry = function() {
			self.countCountryElements(function (data) {
                if (data > self.Country_lookupThreshold) {
                    self.Country_lookupMethod = self.getCountryAutoComplete;
                    self.Country_lookupMinLength(2);
                } else {                   
                    self.getCountryCollectionData();
                    self.Country_lookupMethod = self.getCountryCollectionOneLevel;
                    self.Country_lookupMinLength(0);
                }
            });
		};


	
		// Related data collections loaders
		this.onGetCountryCollectionDataSuccess = function (data) {
			self.setCountryCollection(data);					
			self.isGetCountryCollectionBusy(false);
		};

		this.onGetCountryCollectionDataError = function (error) {
			self.ShowError(error);
			self.isGetCountryCollectionBusy(false);
		};
		
        this.isGetCountryCollectionBusy = ko.observable(false);
		this.loadRelatedData = function () {
			self.selectiveLoadDataForCountry();
		};

        this.SetPlaceObject = function (objectToSet) {
            			
			if (objectToSet && (objectToSet === self.PlaceObject()))
				return;

			if (objectToSet && objectToSet.contextIds)
			    objectToSet.contextIds.push(self.contextId);
			
			if (self.PlaceObject().Data.IsNew() === true) {
				// If the old dataobject has not been saved => not used anymore, remove it from dataset
				self.controller.ObjectsDataSet.RemoveObject(self.PlaceObject());
			}
			
			
			if (objectToSet) {
				var objectFromDataset = self.controller.ObjectsDataSet.GetObject(objectToSet);						
				self.PlaceObject(objectFromDataset);
                self.StatusData.IsEmpty(false);
            }
            else {
                self.StatusData.IsEmpty(true);
            }
			
			self.onPlaceObjectChanged();
			self.Events.PlaceSetInMemory(!self.Events.PlaceSetInMemory());
						
			if (self.StatusData.isPopup()) 
				ApplicationController.centerPopup();	
				
			if (self.isMemoryOnly && self.isOpenInEditMode) {
				self.isOpenInEditMode = false;
				self.Modify();
			}
		};

		this.onPlaceObjectChanged = function() {
			
			// Reload all sub-grids data
			if (self.PlaceObject().Data.IsNew()) {
				self.PlaceToLocationItemsGridViewModel.StatusData.IsFilterVisible(false);
 
				var theCollection = self.PlaceObject().Data.PlaceToLocationItems();
                self.PlaceToLocationItemsGridViewModel.SetPlaceToLocationObjectCollection( theCollection );
				self.PlaceToLocationItemsGridViewModel.isMemoryOnlyCollection = true;
	            self.PlaceToLocationItemsGridViewModel.totalCollection(theCollection !== null ? theCollection.length : 0);
				self.PlaceToLocationItemsGridViewModel.pageNumber(0);	            
				self.PlaceToLocationItemsGridViewModel.totalPageNumber(0);
	        } else {

				self.PlaceToLocationItemsGridViewModel.StatusData.IsFilterVisible(true);

				self.PlaceToLocationItemsGridViewModel.isMemoryOnlyCollection = false;
				
				// Resetting filters
                self.PlaceToLocationItemsGridViewModel.baseFilterPredicate = 'PlaceURI == "' + self.PlaceObject().Data.URI() + '"';
				
				// Taking into account current filter values if any
			    var filterPredicate = self.PlaceToLocationItemsGridViewModel.PlaceToLocationFilterViewModel.getFilterPredicate();
			    if(filterPredicate !== "" && filterPredicate !== null) {
			        self.PlaceToLocationItemsGridViewModel.filterPredicate = self.PlaceToLocationItemsGridViewModel.baseFilterPredicate + ' && (' + filterPredicate + ')';
			    } else {
			        self.PlaceToLocationItemsGridViewModel.filterPredicate = self.PlaceToLocationItemsGridViewModel.baseFilterPredicate;
			    }
				
				// Rebinding subgrid
                self.PlaceToLocationItemsGridViewModel.LoadPlaceToLocationObjectCollection();
            }

			
			// Reload all lookup fields related data
			self.rebindLookups();
 			
			self.StatusData.IsUIDirty(self.controller.ObjectsDataSet.isContextIdDirty(self.contextId));			
		};

 
		this.rebindLookups = function() {
			var relatedCountry = self.PlaceObject().getCountry();
			var relatedCountry_RelatedElementDisplayField = self.PlaceObject().getCountry() === null ? null : self.PlaceObject().getCountry().Data.Name();
            if (relatedCountry !== null && relatedCountry_RelatedElementDisplayField !== null) {
            	self.Country_Name(relatedCountry_RelatedElementDisplayField);
				self.Country_lookupItem({ label: relatedCountry_RelatedElementDisplayField, value: relatedCountry, selectable: true});
			} else {
				self.Country_lookupItem({ label: "", value: null});
            	self.Country_Name(null);
			}
		}
		
        this.GetPlaceObject = function () {
            return self.PlaceObject();
        };

        this.LoadPlace = function (objectToLoad) {
			
			self.StatusData.IsBusy(true);
			var configuration = {};			
			configuration.contextId = self.contextId;
			configuration.include = this.include;
			   

			configuration.pks = {
				URI : objectToLoad.Data.URI()
			};          

			configuration.successHandler =  self.OnPlaceLoaded;
			configuration.errorHandler = self.ShowError;
			self.DataStore.LoadObject(configuration);
        };

        this.Rebind = function() {
			if(self.isMemoryOnly === false) { 
				if(!self.PlaceObject().Data.IsNew()) {
					self.LoadPlace(self.PlaceObject());
				}
				self.loadRelatedData();
			}
        };

        // Define the load completed functions
        this.OnPlaceLoaded = function (objectLoaded) {
			// if we do next line : delete all related entities
			//self.controller.ObjectsDataSet.cleanContext(self.contextId);	
            self.SetPlaceObject(objectLoaded);
            self.StatusData.IsBusy(false);
            // the next line is to force notification of change: this way we emulate event handling
            self.Events.PlaceLoaded(!self.Events.PlaceLoaded());

			// Centers the popup div in case the content made it shift toward the page's bottom
			self.controller.applicationController.centerPopup();
				
			if (!!self.isOpenInEditMode) {
				self.isOpenInEditMode = false;
				self.Modify();
			}
		};

        this.OnPlaceSaved = function (objectSaved) {
			GO.log("PlaceForm", "PlaceObject saved with success");
			self.SetPlaceObject(objectSaved);
			self.EndEdit();
			if (self.StatusData.isPopup()) {
				var preventRebind = false;
				if(self.popupCaller.CallAfterSaveRelatedEntity) {
					// The CallAfterSaveRelatedEntity may return true to prevent rebind when closing the popup
					preventRebind = self.popupCaller.CallAfterSaveRelatedEntity(objectSaved);
				}
                self.closePopup(!preventRebind);
			}
 
        };

			
		this.selectCountryLookupField = function(relatedObject) { 
			if(relatedObject._objectType === 'Country') {
				self.Country_Name(relatedObject.Data.Name());
				self.Country_lookupItem({label: relatedObject.Data.Name(), value:relatedObject});
			}
			self.CallAfterSaveRelatedEntity = null;// reset the value
			return true; // Prevent rebind in the PopupCaller (this lookup is displayed only in edit mode)
		};
			


        this.OnPlaceDeleted = function () {
			GO.log("PlaceForm", "PlaceObject deleted with success");
            self.controller.ObjectsDataSet.cleanContext(self.contextId);	
			self.SetPlaceObject(null);
            self.StatusData.IsBusy(false);
            // the next line is to force notification of change: this way we emulate event handling
            self.Events.PlaceDeleted(!self.Events.PlaceDeleted());
 
			self.closePopup(true);
        };


        //////////////////////////////////////////////

		this.Edit = function () { self.Modify(); }

        this.Modify = function () {
			GO.log("PlaceForm", "Entering modification of PlaceObject");
			
			// propagate to Sub-Grids
			self.PlaceToLocationItemsGridViewModel.isMemoryOnlyCollection = true;	
	        self.SavedData = new Solid.Web.Model.DataObjects.PlaceObject();
			self.SavedData.CopyValuesFrom(self.PlaceObject());

 
            self.StatusData.DisplayMode('edit');
            self.StatusData.PreviousIsEmpty = self.StatusData.IsEmpty();
            self.StatusData.IsEmpty(false);
			
			if (self.StatusData.isPopup())			
				ApplicationController.centerPopup();			
			
			// notify listeners
            self.Events.StartEdit(!self.Events.StartEdit());
        };

        this.CancelEdit = function (isCommandCall) {
			GO.log("PlaceForm", "CancelEdit of PlaceObject");


            self.StatusData.DisplayMode('view');

 
			if (self.PlaceObject().Data.IsNew() === true) {
				// If the old dataobject has not been saved => not used anymore, remove it from dataset
				self.controller.ObjectsDataSet.RemoveObject(self.PlaceObject());
			}

            self.PlaceObject().CopyValuesFrom(self.SavedData);
			self.SavedData = null;
            self.StatusData.IsEmpty(self.StatusData.PreviousIsEmpty);

			self.onPlaceObjectChanged();
            // notify listeners
            self.Events.CancelEdit(!self.Events.CancelEdit());

			// reset contextIds status
			self.controller.ObjectsDataSet.resetContextIdDirty(self.contextId);
			self.resetValidation();

			if (isCommandCall)
			{
 
			}			
            if (self.StatusData.isPopup())
                self.closePopup(false);
        };

        this.EndEdit = function () {
			GO.log("PlaceForm", "EndEdit on PlaceObject");

            self.SavedData = null;
			self.StatusData.DisplayMode('view');
            self.StatusData.IsBusy(false);

            // notify listeners
			self.PlaceObject().StatusData.lastEditedTime(new Date().getTime());
            self.Events.EndEdit(!self.Events.EndEdit());
        };

        this.CreateNew = function () {
			GO.log("PlaceForm", "Creating new PlaceObject");
            self.SavedData = new Solid.Web.Model.DataObjects.PlaceObject();
			self.SavedData.CopyValuesFrom(self.PlaceObject());
            self.StatusData.PreviousIsEmpty = self.StatusData.IsEmpty();
			self.controller.ObjectsDataSet.cleanContext(self.contextId);
	        var objectToAdd = Solid.Web.Model.DataObjects.PlaceObjectFactory.createNew(self.controller.ObjectsDataSet, self.contextId);
			self.SetPlaceObject(objectToAdd);


			self.clearCountryCollection();
			
			self.StatusData.DisplayMode('edit');
            self.StatusData.IsEmpty(false);

  
            // notify listeners
            self.Events.StartEdit(!self.Events.StartEdit());
        };

		this.OnBeforeSave = function() {
			var diff = GO.compareEntities(self.SavedData, self.PlaceObject());
		    GO.log("PlaceForm", "Before Saving (diff)", diff);

			return true;
		};

        this.Save = function () {
			var doContinue = true;

			if (self.customViewModel !== undefined && self.customViewModel.onBeforeSave !== undefined) {
				doContinue = self.customViewModel.onBeforeSave();
			}
		
			if (doContinue) {
                doContinue = self.OnBeforeSave();
            }

            if (doContinue) {

				self.runValidation();
            
				if (self.StatusData.isValid() === false)
					return;

				self.StatusData.IsBusy(true);

				if (self.isMemoryOnly) {
					self.OnPlaceSaved(self.PlaceObject());
				}
				else {
					var configuration = {};			
					configuration.contextId = self.contextId;
					configuration.include = this.include;
					configuration.objectToSave = self.GetPlaceObject();
					configuration.successHandler =  self.OnPlaceSaved;
					configuration.errorHandler = self.ShowError;		
					GO.log("PlaceForm", "Sending payload to PlaceObject DataStore");
					self.DataStore.SaveObject(configuration);
				}
			}

			if (self.customViewModel !== undefined && self.customViewModel.onAfterSave !== undefined) {
				self.customViewModel.onAfterSave();
			}
        };

		this.onConfirmDelete = function (confirm) {
            if (confirm === true) {
				var objectToDelete = self.GetPlaceObject()
				var configuration = {};			
				configuration.contextId = self.contextId;
				configuration.pks = {
					URI : objectToDelete.Data.URI()
			};          

				configuration.successHandler =  self.OnPlaceDeleted;
				configuration.errorHandler = self.ShowError;

				self.DataStore.DeleteObject(configuration);
            }
            else {
                self.StatusData.IsBusy(false);
            }
		};

        this.Delete = function () {
            self.StatusData.IsBusy(true);
			self.controller.applicationController.showConfirmPopup(self, Solid.Web.Messages.confirmDeleteMessage.replace(/%ENTITY%/g, "Place"), Solid.Web.Messages.confirmDeletePopupTitle, self.onConfirmDelete, self.contextId);
        };



		this.release = function() {

			// Remove Custom ViewModel reference
			if (self.customViewModel !== undefined) {
				if(self.customViewModel.release !== undefined) {
				    self.customViewModel.release();
				}
				delete self.customViewModel;
			}

			self.DataStore = null;

			// Related Data Stores 
			delete self.DataStoreCountry.dataSet;
			self.DataStoreCountry = null;
            // Cleaning references to subscriptions & handlers
			self.controller.ObjectsDataSet.RemoveContextIdsStatusChangeHandler(self.onContextIdsStatusChanged);			
			for(var i=0; i < self.subscriptions.length; i++)
			{
				self.subscriptions[i].dispose();
			}
			self.subscriptions = [];
 
			// Lookup fields
			this.Country_Name = ko.observable(null);
			this.Country_lookupItem = ko.observable(null);
 		
			// Sub-grids ViewModels
			self.PlaceToLocationItemsGridViewModel.release();
			self.PlaceToLocationItemsGridViewModel = null;
			// Cleaning the context if data has been saved already
			if (!self.isMemoryOnly) {
				self.controller.ObjectsDataSet.cleanContext(self.contextId);
			}
			if(self.$formContainer) {
				ko.removeNode(self.$formContainer.get(0));
			}
		};


		this.getCurrentTabIndex = function () {
		    return self.StatusData.CurrentTabIndex();
		};		

		this.selectTabIndex = function(tabid) {
			  self.StatusData.CurrentTabIndex(tabid);
		};

		this.TabChangedMethod = function (tabid) {
			if(tabid != self.StatusData.CurrentTabIndex()) 
				self.StatusData.CurrentTabIndex(tabid);
		    if (self.StatusData.isPopup())
		        self.controller.applicationController.centerPopup();
		}
 
        this.ShowError = function (errorMessage, title) {
			self.isOpenInEditMode = false;
			self.controller.applicationController.showAlertPopup(self, errorMessage, title, null, self.contextId);
            self.StatusData.IsBusy(false);
        };		

		this.getErrorClass = ko.pureComputed(function () {
            if (self.customViewModel !== undefined && self.customViewModel.getErrorClass !== undefined) {
                return self.customViewModel.getErrorClass();
            }
            return "errorText";
        });
		
		this.initialize = function() {
			// Call custom initialize if defined
			if (self.customViewModel !== undefined && self.customViewModel.initialize !== undefined) {
			    self.customViewModel.initialize();
			}
		};

		self.initialize();
	
		// Apply bindings
		if (self.$formContainer) {
			ko.applyBindings(self, self.$formContainer.get(0));
    		self.StatusData.IsBusy(false);
		}
	};		

	if (window.ApplicationSourceHandler)
		window.ApplicationSourceHandler.onSourceLoaded("/ViewModels/Place/PlaceFormViewModel.js");
} ());